<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title> </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div class="container mt-5">
        <h1> </h1>
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title" th:text="${post.title}"></h2>
                <p class="card-text" th:text="${post.content}"></p>
                <p class="card-text"><small class="text-muted" th:text="'작성자: ' + ${post.author}"></small></p>
                <p class="card-text"><small class="text-muted"
                        th:text="'작성시각: ' + ${#temporals.format(post.createdDate, 'yyyy-MM-dd HH:mm')}"></small>
                </p>
                <p class="card-text" th:if="${post.modifiedDate}"><small class="text-muted"
                        th:text="'수정시각: ' + ${#temporals.format(post.modifiedDate, 'yyyy-MM-dd HH:mm')}"></small>
                </p>
            </div>
        </div>

        <!-- 수정 및 삭제 버튼 -->
        <button id="editButton" class="btn btn-warning mt-3">게시글 수정</button>
        <button id="deleteButton" class="btn btn-danger mt-3 ms-2">게시글 삭제</button>

        <h3 class="mt-4">댓글</h3>
        <div th:each="comment : ${comments}" class="card mb-2">
            <div class="card-body">
                <p class="card-text" th:text="${comment.content}"></p>
                <p class="card-text">
                    <small class="text-muted" th:text="'By: ' + ${comment.author} + ' on ' + ${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}"></small>
                    <button class="btn btn-sm btn-danger float-end delete-comment" th:attr="data-comment-id=${comment.id}, data-comment-author=${comment.author}">댓글삭제</button>
                    </p>
                </div>
            </div>
        </div>

        <form id="commentForm" class="mt-4">
            <div class="mb-3">
                <label for="content" class="form-label"></label>
                <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">댓글입력</button>
        </form>

        <a th:href="@{/posts}" class="btn btn-secondary mt-3">게시판으로</a>
    </div>

    <script th:inline="javascript">
        $(document).ready(function () {
            var postId = /*[[${post.id}]]*/ 0;

            $('#editButton').click(function () {
                $.ajax({
                    url: '/posts/edit/' + postId,
                    type: 'GET',
                    success: function (response) {
                        window.location.href = response;
                    },
                    error: function (xhr, status, error) {
                        if (xhr.status === 401) {
                            alert('로그인이 필요합니다.');
                            window.location.href = '/login';
                        } else if (xhr.status === 403) {
                            alert('이 게시글을 수정할 권한이 없습니다.');
                        } else {
                            alert('오류가 발생했습니다. 다시 시도해주세요.');
                        }
                    }
                });
            });

            $('#deleteButton').click(function () {
                if (confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
                    $.ajax({
                        url: '/posts/delete/' + postId,
                        type: 'DELETE',
                        success: function (response) {
                            if (response === "success") {
                                alert('게시글이 성공적으로 삭제되었습니다.');
                                window.location.href = '/posts';
                            } else {
                                alert('오류가 발생했습니다. 다시 시도해주세요.');
                            }
                        },
                        error: function (xhr, status, error) {
                            if (xhr.status === 401) {
                                alert('로그인이 필요합니다.');
                                window.location.href = '/login';
                            } else if (xhr.status === 403) {
                                alert('이 게시글을 삭제할 권한이 없습니다.');
                            } else {
                                alert('오류가 발생했습니다. 다시 시도해주세요.');
                            }
                        }
                    });
                }
            });
            $(document).on('click', '.delete-comment', function() {
        var commentId = $(this).data('comment-id');
        var commentAuthor = $(this).data('comment-author');
        var currentUser = /*[[${session.user_info?.name}]]*/ null;

        if (currentUser !== commentAuthor) {
            alert('댓글 작성자만 삭제할 수 있습니다.');
            return;
        }

        if (confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
            $.ajax({
                url: '/comments/' + commentId,
                type: 'DELETE',
                success: function(result) {
                    // 댓글 요소를 DOM에서 제거
                    $(event.target).closest('.card').remove();
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 401) {
                        alert('로그인이 필요합니다.');
                        window.location.href = '/login';
                    } else if (xhr.status === 403) {
                        alert('이 댓글을 삭제할 권한이 없습니다.');
                    } else {
                        alert('오류가 발생했습니다. 다시 시도해주세요.');
                    }
                }
            });
        }
    });


            $('#commentForm').submit(function (e) {
                e.preventDefault();
                var content = $('#content').val();

                $.ajax({
                    url: '/posts/' + postId + '/comments',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content: content }),
                    success: function (commentDTO) {
                        console.log('Success:', commentDTO);
                        addNewComment(commentDTO);
                        $('#content').val('');
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        alert('댓글 추가 중 오류가 발생했습니다: ' + xhr.responseText);
                    }
                });
            });

            function addNewComment(commentDTO) {
                var newCommentHtml = '<div class="card mb-2"><div class="card-body">' +
                    '<p class="card-text">' + commentDTO.content + '</p>' +
                    '<p class="card-text"><small class="text-muted">By: ' + commentDTO.author + ' on ' +
                    new Date(commentDTO.createdDate).toLocaleString() + '</small></p>' +
                    '</div></div>';
                $('#comments').append(newCommentHtml);
            }
        })
    </script>
</body>

</html>