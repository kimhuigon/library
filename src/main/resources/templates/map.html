<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Map</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Kakao Maps API -->
  <script type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6dfaf6fb0d9d9293c6bc9220328e7540&libraries=services"></script>
  
  <style>
    /* 맵 컨테이너 스타일 */
    #map-container {
      margin-top: 20px;
    }

    /* 검색 결과 컨테이너 스타일 */
    #searchResult {
      border: 1px solid #ddd;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px; /* 검색창 및 버튼 아래에 여백 추가 */
    }

    /* 검색 결과 항목 스타일 */
    .resultItem {
      padding: 5px;
      cursor: pointer;
    }

    /* 검색 결과 항목 호버 스타일 */
    .resultItem:hover {
      background-color: #eee;
    }

    /* 인포윈도우 닫기 버튼 스타일 */
    .infowindow-close {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 18px;
    }

    /* 인포윈도우 콘텐츠 스타일 */
    .infowindow-content {
      padding: 10px;
      position: relative;
      width: 220px;
      font-size: 12px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    /* 인포윈도우 도서관 이름 스타일 */
    .infowindow-content .library-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }

    /* 인포윈도우 도서관 정보 스타일 */
    .infowindow-content .library-info {
      margin-bottom: 3px;
    }

    /* 커스텀 버튼 스타일 */
    .btn-custom {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      padding: 5px 10px; /* 크기를 줄임 */
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 15px; /* 둥근 모서리 크기 조정 */
      font-size: 14px; /* 폰트 크기 줄임 */
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s, transform 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* 커스텀 버튼 호버 스타일 */
    .btn-custom:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }

    /* 커스텀 버튼 클릭 스타일 */
    .btn-custom:active {
      background-color: #004494;
      transform: translateY(0);
    }

    /* 하단 텍스트 스타일 */
    .styled-text {
      text-align: center;
      font-family: 'Arial', sans-serif;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>

</head>

<body>
  <!-- 네비바 -->
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container-fluid">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">게시판</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/map">지도</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- 메인 컨테이너 -->
  <div class="container" id="map-container">
    <div class="row">
      <!-- 왼쪽 열 -->
      <div class="col-md-8">
        <div id="map" style="width:100%;height:400px; position: relative;">
          <button onclick="showCurrentLocation()" id="currentLocationButton" class="btn-custom">
            R
          </button>
        </div>
        <h1 id="libraryName" class="styled-text">도서관 찾기</h1>
      </div>
      <!-- 오른쪽 열 -->
      <div class="col-md-4">
        <div class="row mb-3">
          <div class="col-9">
            <input type="text" id="searchInput" class="form-control" placeholder="도서관 이름 또는 시도로 검색" onkeypress="handleKeyPress(event)">
          </div>
          <div class="col-3">
            <button onclick="searchLibraries()" class="btn btn-primary btn-block">검색</button>
          </div>
        </div>
        <div id="searchResult" style="border: 1px solid #ddd; max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- 스크립트 섹션 -->
  <script>
    // 전역 변수 선언
    var map;
    var markers = [];
    var currentLocationMarker = null;
    var currentInfowindow = null;
    var currentLocation = null;
    var geocoder = new kakao.maps.services.Geocoder();
    var selectedLibrary = null; // 선택된 도서관 정보를 저장할 변수

    // 현재 위치 마커 이미지 설정
    var currentMarkerImage = new kakao.maps.MarkerImage(
      'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
      new kakao.maps.Size(24, 35),
      { offset: new kakao.maps.Point(13, 35) }
    );

    // 도서관 마커 이미지 설정 (책 이모지 SVG)
    var libraryMarkerImage = new kakao.maps.MarkerImage(
      'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30">
          <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="20">📚</text>
        </svg>
      `),
      new kakao.maps.Size(30, 30),
      { offset: new kakao.maps.Point(15, 15) }
    );

    // 지도 초기화 함수
    function initMap() {
      var mapContainer = document.getElementById('map');
      var mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 4
      };
      map = new kakao.maps.Map(mapContainer, mapOption);

      // 사용자의 현재 위치 가져오기
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          currentLocation = new kakao.maps.LatLng(lat, lng);

          // 좌표를 주소로 변환
          geocoder.coord2Address(lng, lat, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var address = result[0].address.address_name;
              displayLocation(currentLocation, "현재 위치", null, address);
            } else {
              displayLocation(currentLocation, "현재 위치");
            }
          });

          showNearbyLibraries(lat, lng);
        }, function (error) {
          console.error(error);
          alert("위치 정보를 가져올 수 없습니다. 기본 위치(서울시청)를 중심으로 지도를 표시합니다.");
        });
      } else {
        alert("이 브라우저에서는 Geolocation이 지원되지 않습니다. 기본 위치(서울시청)를 중심으로 지도를 표시합니다.");
      }
    }

    // 엔터 키 입력 처리 함수
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        searchLibraries();
      }
    }

    // 현재 위치 표시 함수
    function showCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          var locPosition = new kakao.maps.LatLng(lat, lng);

          // 좌표를 주소로 변환
          geocoder.coord2Address(lng, lat, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var address = result[0].address.address_name;
              displayLocation(locPosition, "현재 위치", null, address);
            } else {
              displayLocation(locPosition, "현재 위치");
            }
          });

          if (lat && lng) {
            showNearbyLibraries(lat, lng); // 여기서 유효한 lat, lng를 제공
          } else {
            console.error("Invalid latitude or longitude");
          }
        }, function (error) {
          console.error(error);
          alert("현재 위치 정보를 가져올 수 없습니다.");
        });
      } else {
        alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
      }
    }

    // 위치 표시 함수 (현재 위치 또는 도서관 위치)
    function displayLocation(position, title, library = null, address = null) {
      if (currentLocationMarker) {
        currentLocationMarker.setMap(null);
      }
      if (currentInfowindow) {
        currentInfowindow.close();
      }

      currentLocationMarker = new kakao.maps.Marker({
        map: map,
        position: position,
        image: library ? libraryMarkerImage : currentMarkerImage
      });

      var libraryNameElement = document.getElementById('libraryName');
      if (library) {
        libraryNameElement.textContent = `${library.name}: ${library.roaddress ? library.roaddress : ''}`;
      } else if (address) {
        libraryNameElement.textContent = address;
      } else {
        libraryNameElement.textContent = title;
      }

      var infowindowContent = library ? createLibraryInfowindowContent(library) : `
    <div class="infowindow-content" style="text-align:center;">
      <button class="infowindow-close" onclick="closeInfowindow()">&times;</button>
      <div>${title}</div>
      ${address ? `<div>${address}</div>` : ''}
    </div>
  `;

      currentInfowindow = new kakao.maps.InfoWindow({
        content: infowindowContent,
        zIndex: 1
      });

      kakao.maps.event.addListener(currentLocationMarker, 'click', function () {
        currentInfowindow.open(map, currentLocationMarker);
      });

      currentInfowindow.open(map, currentLocationMarker);
      map.setCenter(position);
    }

    // 도서관 검색 함수
    function searchLibraries() {
      var query = document.getElementById('searchInput').value;

      fetch(`/api/libraries/search?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          // 데이터가 배열인지 확인
          const libraries = Array.isArray(data) ? data : [];
          displaySearchResults(libraries);

          if (libraries.length > 0) {
            // 유효한 도서관을 찾을 때까지 반복
            for (const library of libraries) {
              var lat = parseFloat(library.lat);
              var lng = parseFloat(library.lng);

              // 디버깅 메시지
              console.log(`Library: ${library.name}, Lat: ${lat}, Lng: ${lng}`);

              // 유효한 위도와 경도 값인지 확인
              if (!isNaN(lat) && !isNaN(lng)) {
                showNearbyLibraries(lat, lng); // 유효한 도서관의 위치를 기준으로 주변 도서관 검색
                break;
              } else {
                console.error(`Invalid latitude or longitude for the library: ${library.name}`);
              }
            }
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // 주변 도서관 표시 함수
    function showNearbyLibraries(lat, lng) {
      fetch(`/api/libraries/nearby?lat=${lat}&lng=${lng}&distance=5`)
        .then(response => response.json())
        .then(data => {
          // 데이터가 배열인지 확인
          const libraries = Array.isArray(data) ? data : [];
          showLibrariesOnMap(libraries);
        })
        .catch(error => console.error('Error:', error));
    }

    // 검색 결과 표시 함수
    function displaySearchResults(libraries) {
      var searchResultDiv = document.getElementById('searchResult');
      searchResultDiv.innerHTML = '';
      libraries.forEach(library => {
        var resultItem = document.createElement('div');
        resultItem.className = 'resultItem';
        resultItem.innerText = `${library.name} (${library.sido})`;

        // 위도와 경도를 숫자로 변환
        var lat = parseFloat(library.lat);
        var lng = parseFloat(library.lng);

        // 유효한 위도와 경도 값인지 확인
        if (!isNaN(lat) && !isNaN(lng)) {
          resultItem.onclick = function () {
            selectedLibrary = library; // 선택된 도서관 정보 저장
            var position = new kakao.maps.LatLng(lat, lng);
            displayLocation(position, library.name, library);
            showNearbyLibraries(lat, lng); // 클릭 시 해당 위치를 기준으로 주변 도서관 검색
          };
        } else {
          resultItem.onclick = function () {
            console.error(`Invalid latitude or longitude for the selected library: ${library.name}`);
          };
        }

        searchResultDiv.appendChild(resultItem);
      });
    }

    // 도서관 정보를 표시하는 인포윈도우 내용 생성 함수
    function createLibraryInfowindowContent(library) {
      return `
    <div class="infowindow-content">
      <button class="infowindow-close" onclick="closeInfowindow()">&times;</button>
      <div class="library-name">${library.name}</div>
      ${library.roaddress ? `<div class="library-info">${library.roaddress}</div>` : ''}
      ${library.tel ? `<div class="library-info">전화: ${library.tel}</div>` : ''}
      ${library.homepage ? `<div class="library-info"><a href="${library.homepage}" target="_blank">홈페이지</a></div>` : ''}
      <div class="library-info"><a href="#" onclick="findDirections(${library.lat}, ${library.lng}, '${library.name}')">길찾기</a></div>
    </div>
  `;
    }

    // 도서관들을 지도에 표시하는 함수
    function showLibrariesOnMap(libraries) {
      clearMarkers();
      var bounds = new kakao.maps.LatLngBounds();

      libraries.forEach(library => {
        var markerPosition = new kakao.maps.LatLng(library.lat, library.lng);
        var marker = new kakao.maps.Marker({
          position: markerPosition,
          map: map,
          image: libraryMarkerImage
        });
        markers.push(marker);

        var infowindow = new kakao.maps.InfoWindow({
          content: createLibraryInfowindowContent(library)
        });

        kakao.maps.event.addListener(marker, 'click', function () {
          if (currentInfowindow) {
            currentInfowindow.close();
          }
          infowindow.open(map, marker);
          currentInfowindow = infowindow;
        });

        bounds.extend(markerPosition);
      });

      if (libraries.length > 0) {
        map.setBounds(bounds);
      }
    }

    // 길찾기 기능
    function findDirections(lat, lng, libraryName) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var startLat = position.coords.latitude;
          var startLng = position.coords.longitude;
          var startLocationName = "현재위치"; // 출발지 이름 설정

          var directionsUrl = `https://map.kakao.com/link/from/${startLocationName},${startLat},${startLng}/to/${libraryName},${lat},${lng}`;
          // 카카오맵 길찾기 페이지를 새 창으로 열기
          window.open(directionsUrl, '_blank');
        }, function (error) {
          console.error(error);
          alert("현재 위치 정보를 가져올 수 없습니다.");
        });
      } else {
        alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
      }
    }

    // 마커 초기화 함수
    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    // 인포윈도우 닫기 함수
    function closeInfowindow() {
      if (currentInfowindow) {
        currentInfowindow.close();
      }
    }

    // 페이지 로드 시 지도 초기화
    window.onload = initMap;
  </script>
</body>

</html>
