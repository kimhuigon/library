<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Map</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Kakao Maps API -->
  <script type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6dfaf6fb0d9d9293c6bc9220328e7540&libraries=services"></script>
  
  <style>
    /* ë§µ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #map-container {
      margin-top: 20px;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #searchResult {
      border: 1px solid #ddd;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px; /* ê²€ìƒ‰ì°½ ë° ë²„íŠ¼ ì•„ë˜ì— ì—¬ë°± ì¶”ê°€ */
    }

    /* ê²€ìƒ‰ ê²°ê³¼ í•­ëª© ìŠ¤íƒ€ì¼ */
    .resultItem {
      padding: 5px;
      cursor: pointer;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ í•­ëª© í˜¸ë²„ ìŠ¤íƒ€ì¼ */
    .resultItem:hover {
      background-color: #eee;
    }

    /* ì¸í¬ìœˆë„ìš° ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .infowindow-close {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 18px;
    }

    /* ì¸í¬ìœˆë„ìš° ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
    .infowindow-content {
      padding: 10px;
      position: relative;
      width: 220px;
      font-size: 12px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    /* ì¸í¬ìœˆë„ìš° ë„ì„œê´€ ì´ë¦„ ìŠ¤íƒ€ì¼ */
    .infowindow-content .library-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }

    /* ì¸í¬ìœˆë„ìš° ë„ì„œê´€ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .infowindow-content .library-info {
      margin-bottom: 3px;
    }

    /* ì»¤ìŠ¤í…€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-custom {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      padding: 5px 10px; /* í¬ê¸°ë¥¼ ì¤„ì„ */
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 15px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ í¬ê¸° ì¡°ì • */
      font-size: 14px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s, transform 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ì»¤ìŠ¤í…€ ë²„íŠ¼ í˜¸ë²„ ìŠ¤íƒ€ì¼ */
    .btn-custom:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }

    /* ì»¤ìŠ¤í…€ ë²„íŠ¼ í´ë¦­ ìŠ¤íƒ€ì¼ */
    .btn-custom:active {
      background-color: #004494;
      transform: translateY(0);
    }

    /* í•˜ë‹¨ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .styled-text {
      text-align: center;
      font-family: 'Arial', sans-serif;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>

</head>

<body>
  <!-- ë„¤ë¹„ë°” -->
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container-fluid">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">ê²Œì‹œíŒ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/map">ì§€ë„</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="container" id="map-container">
    <div class="row">
      <!-- ì™¼ìª½ ì—´ -->
      <div class="col-md-8">
        <div id="map" style="width:100%;height:400px; position: relative;">
          <button onclick="showCurrentLocation()" id="currentLocationButton" class="btn-custom">
            R
          </button>
        </div>
        <h1 id="libraryName" class="styled-text">ë„ì„œê´€ ì°¾ê¸°</h1>
      </div>
      <!-- ì˜¤ë¥¸ìª½ ì—´ -->
      <div class="col-md-4">
        <div class="row mb-3">
          <div class="col-9">
            <input type="text" id="searchInput" class="form-control" placeholder="ë„ì„œê´€ ì´ë¦„ ë˜ëŠ” ì‹œë„ë¡œ ê²€ìƒ‰" onkeypress="handleKeyPress(event)">
          </div>
          <div class="col-3">
            <button onclick="searchLibraries()" class="btn btn-primary btn-block">ê²€ìƒ‰</button>
          </div>
        </div>
        <div id="searchResult" style="border: 1px solid #ddd; max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ ì„¹ì…˜ -->
  <script>
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    var map;
    var markers = [];
    var currentLocationMarker = null;
    var currentInfowindow = null;
    var currentLocation = null;
    var geocoder = new kakao.maps.services.Geocoder();
    var selectedLibrary = null; // ì„ íƒëœ ë„ì„œê´€ ì •ë³´ë¥¼ ì €ì¥í•  ë³€ìˆ˜

    // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
    var currentMarkerImage = new kakao.maps.MarkerImage(
      'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
      new kakao.maps.Size(24, 35),
      { offset: new kakao.maps.Point(13, 35) }
    );

    // ë„ì„œê´€ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì • (ì±… ì´ëª¨ì§€ SVG)
    var libraryMarkerImage = new kakao.maps.MarkerImage(
      'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30">
          <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="20">ğŸ“š</text>
        </svg>
      `),
      new kakao.maps.Size(30, 30),
      { offset: new kakao.maps.Point(15, 15) }
    );

    // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
    function initMap() {
      var mapContainer = document.getElementById('map');
      var mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 4
      };
      map = new kakao.maps.Map(mapContainer, mapOption);

      // ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          currentLocation = new kakao.maps.LatLng(lat, lng);

          // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜
          geocoder.coord2Address(lng, lat, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var address = result[0].address.address_name;
              displayLocation(currentLocation, "í˜„ì¬ ìœ„ì¹˜", null, address);
            } else {
              displayLocation(currentLocation, "í˜„ì¬ ìœ„ì¹˜");
            }
          });

          showNearbyLibraries(lat, lng);
        }, function (error) {
          console.error(error);
          alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
        });
      } else {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
      }
    }

    // ì—”í„° í‚¤ ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        searchLibraries();
      }
    }

    // í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ í•¨ìˆ˜
    function showCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          var locPosition = new kakao.maps.LatLng(lat, lng);

          // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜
          geocoder.coord2Address(lng, lat, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var address = result[0].address.address_name;
              displayLocation(locPosition, "í˜„ì¬ ìœ„ì¹˜", null, address);
            } else {
              displayLocation(locPosition, "í˜„ì¬ ìœ„ì¹˜");
            }
          });

          if (lat && lng) {
            showNearbyLibraries(lat, lng); // ì—¬ê¸°ì„œ ìœ íš¨í•œ lat, lngë¥¼ ì œê³µ
          } else {
            console.error("Invalid latitude or longitude");
          }
        }, function (error) {
          console.error(error);
          alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        });
      } else {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }

    // ìœ„ì¹˜ í‘œì‹œ í•¨ìˆ˜ (í˜„ì¬ ìœ„ì¹˜ ë˜ëŠ” ë„ì„œê´€ ìœ„ì¹˜)
    function displayLocation(position, title, library = null, address = null) {
      if (currentLocationMarker) {
        currentLocationMarker.setMap(null);
      }
      if (currentInfowindow) {
        currentInfowindow.close();
      }

      currentLocationMarker = new kakao.maps.Marker({
        map: map,
        position: position,
        image: library ? libraryMarkerImage : currentMarkerImage
      });

      var libraryNameElement = document.getElementById('libraryName');
      if (library) {
        libraryNameElement.textContent = `${library.name}: ${library.roaddress ? library.roaddress : ''}`;
      } else if (address) {
        libraryNameElement.textContent = address;
      } else {
        libraryNameElement.textContent = title;
      }

      var infowindowContent = library ? createLibraryInfowindowContent(library) : `
    <div class="infowindow-content" style="text-align:center;">
      <button class="infowindow-close" onclick="closeInfowindow()">&times;</button>
      <div>${title}</div>
      ${address ? `<div>${address}</div>` : ''}
    </div>
  `;

      currentInfowindow = new kakao.maps.InfoWindow({
        content: infowindowContent,
        zIndex: 1
      });

      kakao.maps.event.addListener(currentLocationMarker, 'click', function () {
        currentInfowindow.open(map, currentLocationMarker);
      });

      currentInfowindow.open(map, currentLocationMarker);
      map.setCenter(position);
    }

    // ë„ì„œê´€ ê²€ìƒ‰ í•¨ìˆ˜
    function searchLibraries() {
      var query = document.getElementById('searchInput').value;

      fetch(`/api/libraries/search?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          // ë°ì´í„°ê°€ ë°°ì—´ì¸ì§€ í™•ì¸
          const libraries = Array.isArray(data) ? data : [];
          displaySearchResults(libraries);

          if (libraries.length > 0) {
            // ìœ íš¨í•œ ë„ì„œê´€ì„ ì°¾ì„ ë•Œê¹Œì§€ ë°˜ë³µ
            for (const library of libraries) {
              var lat = parseFloat(library.lat);
              var lng = parseFloat(library.lng);

              // ë””ë²„ê¹… ë©”ì‹œì§€
              console.log(`Library: ${library.name}, Lat: ${lat}, Lng: ${lng}`);

              // ìœ íš¨í•œ ìœ„ë„ì™€ ê²½ë„ ê°’ì¸ì§€ í™•ì¸
              if (!isNaN(lat) && !isNaN(lng)) {
                showNearbyLibraries(lat, lng); // ìœ íš¨í•œ ë„ì„œê´€ì˜ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë³€ ë„ì„œê´€ ê²€ìƒ‰
                break;
              } else {
                console.error(`Invalid latitude or longitude for the library: ${library.name}`);
              }
            }
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // ì£¼ë³€ ë„ì„œê´€ í‘œì‹œ í•¨ìˆ˜
    function showNearbyLibraries(lat, lng) {
      fetch(`/api/libraries/nearby?lat=${lat}&lng=${lng}&distance=5`)
        .then(response => response.json())
        .then(data => {
          // ë°ì´í„°ê°€ ë°°ì—´ì¸ì§€ í™•ì¸
          const libraries = Array.isArray(data) ? data : [];
          showLibrariesOnMap(libraries);
        })
        .catch(error => console.error('Error:', error));
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
    function displaySearchResults(libraries) {
      var searchResultDiv = document.getElementById('searchResult');
      searchResultDiv.innerHTML = '';
      libraries.forEach(library => {
        var resultItem = document.createElement('div');
        resultItem.className = 'resultItem';
        resultItem.innerText = `${library.name} (${library.sido})`;

        // ìœ„ë„ì™€ ê²½ë„ë¥¼ ìˆ«ìë¡œ ë³€í™˜
        var lat = parseFloat(library.lat);
        var lng = parseFloat(library.lng);

        // ìœ íš¨í•œ ìœ„ë„ì™€ ê²½ë„ ê°’ì¸ì§€ í™•ì¸
        if (!isNaN(lat) && !isNaN(lng)) {
          resultItem.onclick = function () {
            selectedLibrary = library; // ì„ íƒëœ ë„ì„œê´€ ì •ë³´ ì €ì¥
            var position = new kakao.maps.LatLng(lat, lng);
            displayLocation(position, library.name, library);
            showNearbyLibraries(lat, lng); // í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë³€ ë„ì„œê´€ ê²€ìƒ‰
          };
        } else {
          resultItem.onclick = function () {
            console.error(`Invalid latitude or longitude for the selected library: ${library.name}`);
          };
        }

        searchResultDiv.appendChild(resultItem);
      });
    }

    // ë„ì„œê´€ ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” ì¸í¬ìœˆë„ìš° ë‚´ìš© ìƒì„± í•¨ìˆ˜
    function createLibraryInfowindowContent(library) {
      return `
    <div class="infowindow-content">
      <button class="infowindow-close" onclick="closeInfowindow()">&times;</button>
      <div class="library-name">${library.name}</div>
      ${library.roaddress ? `<div class="library-info">${library.roaddress}</div>` : ''}
      ${library.tel ? `<div class="library-info">ì „í™”: ${library.tel}</div>` : ''}
      ${library.homepage ? `<div class="library-info"><a href="${library.homepage}" target="_blank">í™ˆí˜ì´ì§€</a></div>` : ''}
      <div class="library-info"><a href="#" onclick="findDirections(${library.lat}, ${library.lng}, '${library.name}')">ê¸¸ì°¾ê¸°</a></div>
    </div>
  `;
    }

    // ë„ì„œê´€ë“¤ì„ ì§€ë„ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function showLibrariesOnMap(libraries) {
      clearMarkers();
      var bounds = new kakao.maps.LatLngBounds();

      libraries.forEach(library => {
        var markerPosition = new kakao.maps.LatLng(library.lat, library.lng);
        var marker = new kakao.maps.Marker({
          position: markerPosition,
          map: map,
          image: libraryMarkerImage
        });
        markers.push(marker);

        var infowindow = new kakao.maps.InfoWindow({
          content: createLibraryInfowindowContent(library)
        });

        kakao.maps.event.addListener(marker, 'click', function () {
          if (currentInfowindow) {
            currentInfowindow.close();
          }
          infowindow.open(map, marker);
          currentInfowindow = infowindow;
        });

        bounds.extend(markerPosition);
      });

      if (libraries.length > 0) {
        map.setBounds(bounds);
      }
    }

    // ê¸¸ì°¾ê¸° ê¸°ëŠ¥
    function findDirections(lat, lng, libraryName) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var startLat = position.coords.latitude;
          var startLng = position.coords.longitude;
          var startLocationName = "í˜„ì¬ìœ„ì¹˜"; // ì¶œë°œì§€ ì´ë¦„ ì„¤ì •

          var directionsUrl = `https://map.kakao.com/link/from/${startLocationName},${startLat},${startLng}/to/${libraryName},${lat},${lng}`;
          // ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° í˜ì´ì§€ë¥¼ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
          window.open(directionsUrl, '_blank');
        }, function (error) {
          console.error(error);
          alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        });
      } else {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }

    // ë§ˆì»¤ ì´ˆê¸°í™” í•¨ìˆ˜
    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    // ì¸í¬ìœˆë„ìš° ë‹«ê¸° í•¨ìˆ˜
    function closeInfowindow() {
      if (currentInfowindow) {
        currentInfowindow.close();
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
    window.onload = initMap;
  </script>
</body>

</html>
