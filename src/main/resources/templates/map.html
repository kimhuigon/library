<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Map</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<<<<<<< HEAD
 
=======
  <!-- Kakao Maps API -->
  <script type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6dfaf6fb0d9d9293c6bc9220328e7540&libraries=services"></script>
>>>>>>> 801ed092cff794f2d3c8fca042bbcb82ea099581
  <style>
    /* ê²€ìƒ‰ ê²°ê³¼ ìŠ¤íƒ€ì¼ */
    #searchResult {
      margin-top: 10px;
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
    }

    .resultItem {
      padding: 5px;
      cursor: pointer;
    }

    .resultItem:hover {
      background-color: #eee;
    }

    /* ì¸í¬ìœˆë„ìš° ìŠ¤íƒ€ì¼ */
    .infowindow-close {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 18px;
    }

    .infowindow-content {
      padding: 10px;
      position: relative;
      width: 220px;
      font-size: 12px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    .infowindow-content .library-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .infowindow-content .library-info {
      margin-bottom: 3px;
    }

    /* ì§€ë„ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #map-container {
      margin-top: 20px;
    }

    /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #currentLocationButton {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
    }

    #currentLocationButton img {
      width: 24px;
      height: 35px;
      display: block;
    }

    #currentLocationButton:hover img {
      transform: scale(1.1);
    }

    /* íŒì—… ì°½ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-dialog {
      margin: 15% auto;
    }
  </style>
</head>

<body>
  <!-- ë„¤ë¹„ë°” -->
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container-fluid">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">ê²Œì‹œíŒ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/map">ì§€ë„</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container" id="map-container">
    <h1 id="libraryName" style="text-align: center;">ë„ì„œê´€ ì°¾ê¸°</h1>
    <div class="row mb-3">
      <div class="col">
        <input type="text" id="searchInput" class="form-control" placeholder="ë„ì„œê´€ ì´ë¦„ ë˜ëŠ” ì‹œë„ë¡œ ê²€ìƒ‰" onkeypress="handleKeyPress(event)">
      </div>
      <div class="col-auto">
        <button onclick="searchLibraries()" class="btn btn-primary">ê²€ìƒ‰</button>
      </div>
      <div class="col-auto">
        <button onclick="findDirections()" class="btn btn-primary">ê¸¸ì°¾ê¸°</button>
      </div>
    </div>
    <div id="map" style="width:100%;height:400px; position: relative;">
      <button onclick="showCurrentLocation()" id="currentLocationButton" class="btn btn-link" style="position: absolute; bottom: 10px; right: 10px; z-index: 1000; color: black;">í˜„ìœ„ì¹˜</button>
    </div>
    <div id="searchResult"></div>

    
    <!-- ê¸¸ì°¾ê¸° -->
    <div id="directionsPopup" class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ê¸¸ì°¾ê¸°</h5>
            <button type="button" class="close" onclick="closeDirectionsPopup()" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="startLocation">ì¶œë°œì§€</label>
              <input type="text" id="startLocation" class="form-control" placeholder="ì¶œë°œì§€ ì£¼ì†Œ">
            </div>
            <div class="form-group">
              <label for="endLocation">ëª©ì ì§€</label>
              <input type="text" id="endLocation" class="form-control" placeholder="ëª©ì ì§€ ì£¼ì†Œ">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="findDirections()">ê¸¸ì°¾ê¸°</button>
            <button type="button" class="btn btn-secondary" onclick="closeDirectionsPopup()">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>

    <div id="map" style="width:100%;height:400px; position: relative;">
      <button onclick="showCurrentLocation()" id="currentLocationButton">
        <img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png" alt="í˜„ì¬ ìœ„ì¹˜">
      </button>
    </div>
    <div id="searchResult"></div>
  </div>
 <!-- Kakao Maps API -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6dfaf6fb0d9d9293c6bc9220328e7540&libraries=services"></script>
  <script>
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    var map;
    var markers = [];
    var currentLocationMarker = null;
    var currentInfowindow = null;
    var currentLocation = null;
    var geocoder = new kakao.maps.services.Geocoder();
    var selectedLibrary = null; // ì„ íƒëœ ë„ì„œê´€ ì •ë³´ë¥¼ ì €ì¥í•  ë³€ìˆ˜

    // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
    var currentMarkerImage = new kakao.maps.MarkerImage(
      'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
      new kakao.maps.Size(24, 35),
      { offset: new kakao.maps.Point(13, 35) }
    );

    // ë„ì„œê´€ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì • (ì±… ì´ëª¨ì§€ SVG)
    var libraryMarkerImage = new kakao.maps.MarkerImage(
      'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30">
          <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="20">ğŸ“š</text>
        </svg>
      `),
      new kakao.maps.Size(30, 30),
      { offset: new kakao.maps.Point(15, 15) }
    );

    // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
    function initMap() {
      var mapContainer = document.getElementById('map');
      var mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 7
      };
      map = new kakao.maps.Map(mapContainer, mapOption);

      // ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          currentLocation = new kakao.maps.LatLng(lat, lng);

          // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜
          geocoder.coord2Address(lng, lat, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var address = result[0].address.address_name;
              displayLocation(currentLocation, "í˜„ì¬ ìœ„ì¹˜", null, address);
            } else {
              displayLocation(currentLocation, "í˜„ì¬ ìœ„ì¹˜");
            }
          });

          showNearbyLibraries(lat, lng);
        }, function (error) {
          console.error(error);
          alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
        });
      } else {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
      }
    }

    // ì—”í„° í‚¤ ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        searchLibraries();
      }
    }

// í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ í•¨ìˆ˜
function showCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var lat = position.coords.latitude;
      var lng = position.coords.longitude;
      var locPosition = new kakao.maps.LatLng(lat, lng);

      // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜
      geocoder.coord2Address(lng, lat, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
          var address = result[0].address.address_name;
          displayLocation(locPosition, "í˜„ì¬ ìœ„ì¹˜", null, address);
        } else {
          displayLocation(locPosition, "í˜„ì¬ ìœ„ì¹˜");
        }
      });

      showNearbyLibraries(lat, lng);
    }, function(error) {
      console.error(error);
      alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    });
  } else {
    alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  }
}

// ìœ„ì¹˜ í‘œì‹œ í•¨ìˆ˜ (í˜„ì¬ ìœ„ì¹˜ ë˜ëŠ” ë„ì„œê´€ ìœ„ì¹˜)
function displayLocation(position, title, library = null, address = null) {
  if (currentLocationMarker) {
    currentLocationMarker.setMap(null);
  }
  if (currentInfowindow) {
    currentInfowindow.close();
  }

  currentLocationMarker = new kakao.maps.Marker({
    map: map,
    position: position,
    image: library ? libraryMarkerImage : currentMarkerImage
  });

  var libraryNameElement = document.getElementById('libraryName');
  if (library) {
    libraryNameElement.textContent = `${library.name}: ${library.roaddress ? library.roaddress : ''}`;
  } else if (address) {
    libraryNameElement.textContent = address;
  } else {
    libraryNameElement.textContent = title;
  }

  var infowindowContent = library ? createLibraryInfowindowContent(library) : `
    <div class="infowindow-content" style="text-align:center;">
      <button class="infowindow-close" onclick="closeInfowindow()">&times;</button>
      <div>${title}</div>
      ${address ? `<div>${address}</div>` : ''}
    </div>
  `;

  currentInfowindow = new kakao.maps.InfoWindow({
    content: infowindowContent,
    zIndex: 1
  });

  kakao.maps.event.addListener(currentLocationMarker, 'click', function() {
    currentInfowindow.open(map, currentLocationMarker);
  });

  currentInfowindow.open(map, currentLocationMarker);
  map.setCenter(position);
}


// ë„ì„œê´€ ê²€ìƒ‰ í•¨ìˆ˜
function searchLibraries() {
  var query = document.getElementById('searchInput').value;

  fetch(`/api/libraries/search?query=${encodeURIComponent(query)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok ' + response.statusText);
      }
      return response.json();
    })
    .then(data => {
      displaySearchResults(data);
    })
    .catch(error => console.error('Error:', error));
}


// ì£¼ë³€ ë„ì„œê´€ í‘œì‹œ í•¨ìˆ˜
function showNearbyLibraries(lat, lng) {
  fetch(`/api/libraries/nearby?lat=${lat}&lng=${lng}&distance=5`)
    .then(response => response.json())
    .then(data => {
      showLibrariesOnMap(data);
    })
    .catch(error => console.error('Error:', error));
}


// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function displaySearchResults(libraries) {
  var searchResultDiv = document.getElementById('searchResult');
  searchResultDiv.innerHTML = '';
  libraries.forEach(library => {
    var resultItem = document.createElement('div');
    resultItem.className = 'resultItem';
    resultItem.innerText = `${library.name} (${library.sido})`;
    resultItem.onclick = function() {
      selectedLibrary = library; // ì„ íƒëœ ë„ì„œê´€ ì •ë³´ ì €ì¥
      var position = new kakao.maps.LatLng(library.lat, library.lng);
      displayLocation(position, library.name, library);
      showNearbyLibraries(library.lat, library.lng); // í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë³€ ë„ì„œê´€ ê²€ìƒ‰
    };
    searchResultDiv.appendChild(resultItem);
  });
}


// ë„ì„œê´€ ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” ì¸í¬ìœˆë„ìš° ë‚´ìš© ìƒì„± í•¨ìˆ˜
function createLibraryInfowindowContent(library) {
  return `
    <div class="infowindow-content">
      <button class="infowindow-close" onclick="closeInfowindow()">&times;</button>
      <div class="library-name">${library.name}</div>
      ${library.roaddress ? `<div class="library-info">${library.roaddress}</div>` : ''}
      ${library.tel ? `<div class="library-info">ì „í™”: ${library.tel}</div>` : ''}
      ${library.homepage ? `<div class="library-info"><a href="${library.homepage}" target="_blank">í™ˆí˜ì´ì§€</a></div>` : ''}
    </div>
  `;
}

// ë„ì„œê´€ë“¤ì„ ì§€ë„ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function showLibrariesOnMap(libraries) {
  clearMarkers();
  var bounds = new kakao.maps.LatLngBounds();

  libraries.forEach(library => {
    var markerPosition = new kakao.maps.LatLng(library.lat, library.lng);
    var marker = new kakao.maps.Marker({
      position: markerPosition,
      map: map,
      image: libraryMarkerImage
    });
    markers.push(marker);

    var infowindow = new kakao.maps.InfoWindow({
      content: createLibraryInfowindowContent(library)
    });

    kakao.maps.event.addListener(marker, 'click', function() {
      if (currentInfowindow) {
        currentInfowindow.close();
      }
      infowindow.open(map, marker);
      currentInfowindow = infowindow;
    });

    bounds.extend(markerPosition);
  });

  if (libraries.length > 0) {
    map.setBounds(bounds);
  }
}

 // ë§ˆì»¤ ì´ˆê¸°í™” í•¨ìˆ˜
function clearMarkers() {
  markers.forEach(marker => marker.setMap(null));
  markers = [];
}

// ì¸í¬ìœˆë„ìš° ë‹«ê¸° í•¨ìˆ˜
function closeInfowindow() {
  if (currentInfowindow) {
    currentInfowindow.close();
  }
}

    // ê¸¸ì°¾ê¸° ê¸°ëŠ¥
    function findDirections() {
      if (!selectedLibrary) {
        alert('ë„ì„œê´€ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      var lat = selectedLibrary.lat;
      var lng = selectedLibrary.lng;

      // í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ì„¤ì •
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var startLat = position.coords.latitude;
          var startLng = position.coords.longitude;
          var startLocationName = "í˜„ì¬ìœ„ì¹˜"; // ì¶œë°œì§€ ì´ë¦„ ì„¤ì •

          var directionsUrl = `https://map.kakao.com/link/from/${startLocationName},${startLat},${startLng}/to/${selectedLibrary.name},${lat},${lng}`;
          // ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° í˜ì´ì§€ë¥¼ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
          window.open(directionsUrl, '_blank');
        }, function (error) {
          console.error(error);
          alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        });
      } else {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
    window.onload = initMap;
  </script>
</body>

</html>