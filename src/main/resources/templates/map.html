<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Map</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/common.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
    }

    a {
      text-decoration: none;
    }

    /* ì§€ë„ ì»¨í…Œì´ë„ˆ ì—¬ë°± */
    #map-container {
      margin-top: 20px;
      height: calc(100vh - 250px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      overflow: hidden; /* ë„˜ì¹˜ëŠ” ë¶€ë¶„ ìˆ¨ê¹€ */
      position: relative;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ ì»¨í…Œì´ë„ˆ */
    #searchResult {
      border: 1px solid #ddd;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
      text-align: left;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
    }

    /* ê°œë³„ ê²€ìƒ‰ ê²°ê³¼ í•­ëª© */
    .resultItem {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      font-size: 16px;
    }

    .resultItem i {
      margin-right: 10px;
    }

    .resultItem:hover {
      background-color: #f8f9fa;
    }

    /* ê²€ìƒ‰ ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .input-group {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì ì¶”ê°€ */
      border-radius: 5px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
    }

    .input-group .form-control {
      border-right: none; /* ì˜¤ë¥¸ìª½ ê²½ê³„ì„  ì œê±° */
      border-radius: 5px 0 0 5px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
    }

    .input-group .btn {
      border-left: none; /* ì™¼ìª½ ê²½ê³„ì„  ì œê±° */
      border-radius: 0 5px 5px 0; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
    }

    /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ */
    .btn-custom {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      width: 30px;
      height: 30px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
    }

    .btn-custom:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
      opacity: 1; /* í˜¸ë²„ ì‹œ íˆ¬ëª…ë„ ì œê±° */
    }

    .btn-custom:active {
      background-color: #004494;
      transform: translateY(0);
    }

    /* ìŠ¤íƒ€ì¼ í…ìŠ¤íŠ¸ */
    .styled-text {
      text-align: center;
      font-family: 'Arial', sans-serif;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* ë„ì„œê´€ ì •ë³´ ë°•ìŠ¤ */
    #libraryInfo {
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      text-align: left;
    }

    #libraryInfo h3 {
      margin-bottom: 20px;
      color: #007bff;
    }

    #libraryInfo p {
      margin-bottom: 15px;
      font-size: 16px;
    }

    /* ì¸í¬ìœˆë„ìš° ë‚´ìš© */
    .infowindow-content {
      padding: 10px;
      position: relative;
      width: 220px;
      font-size: 12px;
      text-align: center;
      line-height: 1.3;
      word-wrap: break-word;
    }

    /* ì¸í¬ìœˆë„ìš° ë‹«ê¸° ë²„íŠ¼ */
    .infowindow-close {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 18px;
    }

    /* í˜„ì¬ ìœ„ì¹˜ ì •ë³´ ë°•ìŠ¤ */
    #currentLocationInfo {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: #007bff;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* ì£¼ì†Œ ì»¨í…Œì´ë„ˆ */
    #addressContainer {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-top: 10px;
      padding: 15px;
      background-color: #e9ecef;
      border-radius: 10px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s;
    }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="top">
      <h1>MAP PAGE</h1>
    </div>
    <!-- ë„¤ë¹„ë°” -->
    <div id="navi">
      <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <div class="container-fluid">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/posts">ê²Œì‹œíŒ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/map">ì§€ë„</a>
            </li>
          </ul>
        </div>
      </nav>
      <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
      <div class="container" id="map-container">
        <div class="row">
          <!-- ì™¼ìª½ ì—´ -->
          <div class="col-md-8">
            <div id="map" style="width:100%;height:400px; position: relative;">
              <button onclick="showCurrentLocation()" id="currentLocationButton" class="btn-custom">
                R
              </button>
            </div>
          </div>
          <!-- ì˜¤ë¥¸ìª½ ì—´ -->
          <div class="col-md-4">
            <div id="searchArea">
              <div class="input-group mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder=""
                  onkeypress="handleKeyPress(event)">
                <button onclick="searchLibraries()" class="btn btn-primary">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <div id="searchResult"></div>
            </div>
            <div id="libraryInfo" style="display: none;">
              <!-- ë„ì„œê´€ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
          </div>
        </div>
        <div id="addressContainer" class="styled-text">í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
        <div id="currentLocationInfo" style="display: none;"></div>
      </div>
      <!-- ìŠ¤í¬ë¦½íŠ¸ ì„¹ì…˜ -->
      <script>
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        var map;
        var markers = [];
        var currentLocationMarker = null;
        var currentLocation = null;
        var ps;
        var currentMarkerImage;
        var libraryMarkerImage;
        var currentInfowindow = null;
        var initialZoomLevel = 4;

        // ì¹´ì¹´ì˜¤ ë§µ API ë¹„ë™ê¸° ë¡œë“œ
        function loadKakaoMapsScript() {
          const script = document.createElement('script');
          script.src = '//dapi.kakao.com/v2/maps/sdk.js?appkey=6dfaf6fb0d9d9293c6bc9220328e7540&libraries=services&autoload=false';
          script.onload = initializeMap;
          document.head.appendChild(script);
        }

        // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeMap() {
          kakao.maps.load(function () {
            ps = new kakao.maps.services.Places();
            var mapContainer = document.getElementById('map');
            var mapOption = {
              center: new kakao.maps.LatLng(37.5665, 126.9780),
              level: initialZoomLevel // ì´ˆê¸° ì¤Œ ë ˆë²¨ ì„¤ì •
            };
            map = new kakao.maps.Map(mapContainer, mapOption);

            // ì¼ë°˜ ì§€ë„ì™€ ìŠ¤ì¹´ì´ë·°ë¡œ ì§€ë„ íƒ€ì…ì„ ì „í™˜í•  ìˆ˜ ìˆëŠ” ì§€ë„íƒ€ì… ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•©ë‹ˆë‹¤
            var mapTypeControl = new kakao.maps.MapTypeControl();

            // ì§€ë„ì— ì»¨íŠ¸ë¡¤ì„ ì¶”ê°€í•´ì•¼ ì§€ë„ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤
            // kakao.maps.ControlPositionì€ ì»¨íŠ¸ë¡¤ì´ í‘œì‹œë  ìœ„ì¹˜ë¥¼ ì •ì˜í•˜ëŠ”ë° TOPRIGHTëŠ” ì˜¤ë¥¸ìª½ ìœ„ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // ì§€ë„ í™•ëŒ€ ì¶•ì†Œë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ”  ì¤Œ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•©ë‹ˆë‹¤
            var zoomControl = new kakao.maps.ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            // ì¤Œ ë³€ê²½ ì‹œ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
            kakao.maps.event.addListener(map, 'zoom_changed', function () {
              closeInfowindow();
            });


            // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
            currentMarkerImage = new kakao.maps.MarkerImage(
              'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
              new kakao.maps.Size(24, 35),
              { offset: new kakao.maps.Point(13, 35) }
            );

            // ë„ì„œê´€ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì • (ì±… ì´ëª¨ì§€ SVG)
            libraryMarkerImage = new kakao.maps.MarkerImage(
              'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30">
              <circle cx="12" cy="12" r="11" stroke="black" stroke-width="1" fill="black" />
              <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="20">ğŸ“š</text>
            </svg>
          `),
              new kakao.maps.Size(30, 30),
              { offset: new kakao.maps.Point(15, 15) }
            );

            // ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                currentLocation = new kakao.maps.LatLng(lat, lng);
                displayLocation(currentLocation, "í˜„ì¬ ìœ„ì¹˜", true);
                showNearbyLibraries(lat, lng);
                fetchAddress(lat, lng, "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ");
              }, function (error) {
                console.error(error);
                alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                document.getElementById('addressContainer').innerText = "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
              });
            } else {
              alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ì‹œì²­)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
              document.getElementById('addressContainer').innerText = "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            }
          });
        }

        // ì—”í„° í‚¤ ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜
        function handleKeyPress(event) {
          if (event.key === 'Enter') {
            searchLibraries();
          }
        }

        // í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ í•¨ìˆ˜
        function showCurrentLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
              var lat = position.coords.latitude;
              var lng = position.coords.longitude;
              var locPosition = new kakao.maps.LatLng(lat, lng);
              closeInfowindow(); // ê¸°ì¡´ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
              displayLocation(locPosition, "í˜„ì¬ ìœ„ì¹˜", true);
              showNearbyLibraries(lat, lng);
              fetchAddress(lat, lng, "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ");
            }, function (error) {
              console.error(error);
              alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              document.getElementById('addressContainer').innerText = "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            });
          } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            document.getElementById('addressContainer').innerText = "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
          }
        }

        // ìœ„ì¹˜ í‘œì‹œ í•¨ìˆ˜ (í˜„ì¬ ìœ„ì¹˜ ë˜ëŠ” ë„ì„œê´€ ìœ„ì¹˜)
        function displayLocation(position, title, isCurrentLocation = false) {
          if (currentLocationMarker) {
            currentLocationMarker.setMap(null);
          }

          currentLocationMarker = new kakao.maps.Marker({
            map: map,
            position: position,
            image: currentMarkerImage,
            zIndex: 1000 // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ zIndex ì„¤ì •
          });

          var infowindowContent =
            '<div class="custom-infowindow">' +
            '<div class="infowindow-content">' + title + '</div>' +
            '<button class="infowindow-close" onclick="closeInfowindow()" title="ë‹«ê¸°">&times;</button>' +
            '</div>';

          var infowindow = new kakao.maps.InfoWindow({
            content: infowindowContent,
            zIndex: 1000 // í˜„ì¬ ìœ„ì¹˜ ì¸í¬ìœˆë„ìš° zIndex ì„¤ì •
          });

          kakao.maps.event.addListener(currentLocationMarker, 'click', function () {
            closeInfowindow();
            infowindow.open(map, currentLocationMarker);
            currentInfowindow = infowindow;
          });

          infowindow.open(map, currentLocationMarker);
          currentInfowindow = infowindow;

          setTimeout(function () {
            map.setLevel(initialZoomLevel); // ì¤Œ ë ˆë²¨ ì„¤ì •
            map.setCenter(position); // ë§µì˜ ì¤‘ì‹¬ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì„¤ì •
          }, 50);
        }

        // ë„ì„œê´€ ê²€ìƒ‰ í•¨ìˆ˜
        function searchLibraries() {
          var query = document.getElementById('searchInput').value;
          if (!query) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }

          // ì¹´ì¹´ì˜¤ë§µ ì¥ì†Œ ê²€ìƒ‰ API ì‚¬ìš©
          ps.keywordSearch(query, function (data, status) {
            if (status === kakao.maps.services.Status.OK) {
              // í•„í„°ë§ ë¡œì§ ì¶”ê°€
              var filteredData = data.filter(function (item) {
                return item.place_name.includes(query);
              });

              if (filteredData.length === 0) {
                alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
              } else {
                displaySearchResults(filteredData);
                // ê²€ìƒ‰ëœ ìœ„ì¹˜ì— ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
                var firstPlace = filteredData[0];
                var position = new kakao.maps.LatLng(firstPlace.y, firstPlace.x);

                // ì´ì „ ê²€ìƒ‰ëœ ìœ„ì¹˜ ë§ˆì»¤ ì œê±°
                if (currentLocationMarker) {
                  currentLocationMarker.setMap(null);
                }

                // ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
                currentLocationMarker = new kakao.maps.Marker({
                  position: position,
                  map: map,
                  image: currentMarkerImage
                });

                setTimeout(function () {
                  map.setLevel(initialZoomLevel); // ì¤Œ ë ˆë²¨ ì„¤ì •
                  map.setCenter(position); // ë§µì˜ ì¤‘ì‹¬ì„ ê²€ìƒ‰ëœ ìœ„ì¹˜ë¡œ ì„¤ì •
                }, 50);

                fetchAddress(firstPlace.y, firstPlace.x, "ê²€ìƒ‰ëœ ìœ„ì¹˜ ì£¼ì†Œ: ");
                showNearbyLibraries(firstPlace.y, firstPlace.x);
              }
            } else {
              alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
          });
        }


        // ì£¼ë³€ ë„ì„œê´€ í‘œì‹œ í•¨ìˆ˜
        function showNearbyLibraries(lat, lng) {
          // API í˜¸ì¶œí•˜ì—¬ SQLì— ë“±ë¡ëœ ë„ì„œê´€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          fetch(`/api/libraries/nearby?lat=${lat}&lng=${lng}&distance=5`)
            .then(response => response.json())
            .then(libraries => {
              showLibrariesOnMap(libraries);
            })
            .catch(error => console.error('Error:', error));
        }

        // ë„ì„œê´€ë“¤ì„ ì§€ë„ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showLibrariesOnMap(libraries) {
          clearMarkers();
          var bounds = new kakao.maps.LatLngBounds();

          libraries.forEach(library => {
            var markerPosition = new kakao.maps.LatLng(library.lat, library.lng);
            var marker = new kakao.maps.Marker({
              position: markerPosition,
              map: map,
              image: libraryMarkerImage
            });
            markers.push(marker);

            var infowindowContent =
              '<div class="custom-infowindow">' +
              '<div class="infowindow-content">' + library.name + '</div>' +
              '<button class="infowindow-close" onclick="closeInfowindow()" title="ë‹«ê¸°">&times;</button>' +
              '</div>';

            var infowindow = new kakao.maps.InfoWindow({
              content: infowindowContent,
              zIndex: 1000 // ë„ì„œê´€ ì¸í¬ìœˆë„ìš° zIndex ì„¤ì •
            });

            kakao.maps.event.addListener(marker, 'click', function () {
              closeInfowindow(); // ê¸°ì¡´ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
              infowindow.open(map, marker);
              currentInfowindow = infowindow;
              showLibraryInfo(library);
              fetchAddress(library.lat, library.lng, "ë„ì„œê´€ ì£¼ì†Œ: ");
            });

            bounds.extend(markerPosition);
          });

          if (libraries.length > 0) {
            map.setBounds(bounds);
            map.setLevel(initialZoomLevel); // ì¤Œ ë ˆë²¨ ê³ ì •
          }
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ ìˆ˜ì •
        function displaySearchResults(libraries) {
          var searchResultDiv = document.getElementById('searchResult');
          searchResultDiv.innerHTML = '';
          libraries.forEach(function (library) {
            var resultItem = document.createElement('div');
            resultItem.className = 'resultItem';
            resultItem.innerHTML = `<i class="fas fa-map-marker-alt mr-2"></i> ${library.place_name}`;
            resultItem.onclick = function () {
              var position = new kakao.maps.LatLng(library.y, library.x);
              map.setCenter(position);

              // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
              if (currentLocationMarker) {
                currentLocationMarker.setMap(null);
              }

              // ìƒˆ ë§ˆì»¤ ìƒì„± ë° í‘œì‹œ
              currentLocationMarker = new kakao.maps.Marker({
                position: position,
                map: map,
                image: currentMarkerImage
              });

              setTimeout(function () {
                map.setLevel(initialZoomLevel); // ì¤Œ ë ˆë²¨ ì¬ì„¤ì •
                map.setCenter(position); // ë‹¤ì‹œ í•œë²ˆ ì¤‘ì‹¬ ì„¤ì •
              }, 50);

              fetchAddress(library.y, library.x, "ì„ íƒí•œ ë„ì„œê´€ ì£¼ì†Œ: ");
              showNearbyLibraries(library.y, library.x);
            };
            searchResultDiv.appendChild(resultItem);
          });
        }


        // ë„ì„œê´€ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function showLibraryInfo(library) {
          var searchArea = document.getElementById('searchArea');
          var libraryInfo = document.getElementById('libraryInfo');

          searchArea.style.display = 'none';
          libraryInfo.style.display = 'block';

          libraryInfo.innerHTML = `
        <h3>${library.name}</h3>
        <p><i class="fas fa-map-marker-alt"></i> ì£¼ì†Œ: ${library.roaddress || 'ì •ë³´ ì—†ìŒ'}</p>
        <p><i class="fas fa-phone"></i> ì „í™”: ${library.tel || 'ì •ë³´ ì—†ìŒ'}</p>
        <p><i class="fas fa-globe"></i> ${library.homepage ? `<a href="${library.homepage}" target="_blank">í™ˆí˜ì´ì§€</a>` : 'ì •ë³´ ì—†ìŒ'}</p>
        <p><a href="#" onclick="findDirections(${library.lat}, ${library.lng}, '${library.name}')"><i class="fas fa-directions"></i> ê¸¸ì°¾ê¸°</a></p>
        <button onclick="showSearchArea()" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> ê²€ìƒ‰ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      `;
        }

        // ê¸¸ì°¾ê¸° ê¸°ëŠ¥
        function findDirections(lat, lng, libraryName) {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
              var startLat = position.coords.latitude;
              var startLng = position.coords.longitude;
              var startLocationName = "í˜„ì¬ìœ„ì¹˜";

              var directionsUrl = `https://map.kakao.com/link/from/${startLocationName},${startLat},${startLng}/to/${libraryName},${lat},${lng}`;
              window.open(directionsUrl, '_blank');
            }, function (error) {
              console.error(error);
              alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            });
          } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        }

        // ë§ˆì»¤ ì´ˆê¸°í™” í•¨ìˆ˜
        function clearMarkers() {
          markers.forEach(marker => marker.setMap(null));
          markers = [];
        }

        // ê²€ìƒ‰ ì˜ì—­ìœ¼ë¡œ ëŒì•„ê°€ëŠ” í•¨ìˆ˜
        function showSearchArea() {
          document.getElementById('searchArea').style.display = 'block';
          document.getElementById('libraryInfo').style.display = 'none';
        }

        // ì¸í¬ìœˆë„ìš° ë‹«ê¸° í•¨ìˆ˜
        function closeInfowindow() {
          if (currentInfowindow) {
            currentInfowindow.close();
            currentInfowindow = null;
          }
        }

        // ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function fetchAddress(lat, lng, prefix) {
          var geocoder = new kakao.maps.services.Geocoder();
          var coord = new kakao.maps.LatLng(lat, lng);
          geocoder.coord2Address(coord.getLng(), coord.getLat(), function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var address = result[0].address.address_name;
              document.getElementById('addressContainer').innerText = prefix + address;
            } else {
              document.getElementById('addressContainer').innerText = prefix + "ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
          });
        }

        // ê²€ìƒ‰ ì˜ì—­ìœ¼ë¡œ ëŒì•„ê°€ëŠ” í•¨ìˆ˜
        function showSearchArea() {
          document.getElementById('searchArea').style.display = 'block';
          document.getElementById('libraryInfo').style.display = 'none';

          // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
          document.getElementById('searchInput').value = '';

          // ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ ì´ˆê¸°í™”
          document.getElementById('searchResult').innerHTML = '';

          // ì§€ë„ ìœ„ì˜ ë§ˆì»¤ë“¤ ì œê±°
          clearMarkers();

          // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì œê±°
          if (currentLocationMarker) {
            currentLocationMarker.setMap(null);
            currentLocationMarker = null;
          }

          // ì¸í¬ìœˆë„ìš° ë‹«ê¸°
          closeInfowindow();

          // ì§€ë„ë¥¼ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê³  ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
          if (currentLocation) {
            map.setCenter(currentLocation);
            displayLocation(currentLocation, "í˜„ì¬ ìœ„ì¹˜", true);
            showNearbyLibraries(currentLocation.getLat(), currentLocation.getLng());

            // í˜„ì¬ ìœ„ì¹˜ì˜ ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
            fetchAddress(currentLocation.getLat(), currentLocation.getLng(), "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ");
          } else {
            // í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ëŠ” ê²½ìš°
            document.getElementById('addressContainer').innerText = "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

            // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹œë„
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                currentLocation = new kakao.maps.LatLng(lat, lng);
                map.setCenter(currentLocation);
                displayLocation(currentLocation, "í˜„ì¬ ìœ„ì¹˜", true);
                showNearbyLibraries(lat, lng);
                fetchAddress(lat, lng, "í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ: ");
              }, function (error) {
                console.error(error);
                alert("í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              });
            } else {
              alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
          }
        }

        // ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€)
        function fetchAddress(lat, lng, prefix) {
          var geocoder = new kakao.maps.services.Geocoder();
          var coord = new kakao.maps.LatLng(lat, lng);
          geocoder.coord2Address(coord.getLng(), coord.getLat(), function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
              var address = result[0].address.address_name;
              document.getElementById('addressContainer').innerText = prefix + address;
            } else {
              document.getElementById('addressContainer').innerText = prefix + "ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
          });
        }

        // ì¸í¬ìœˆë„ìš° ë‹«ê¸° í•¨ìˆ˜
        function closeInfowindow() {
          if (currentInfowindow) {
            currentInfowindow.close();
            currentInfowindow = null;
          }
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ì¹´ì˜¤ ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
        window.onload = loadKakaoMapsScript;
      </script>
</body>

</html>